# Fluxgym-coach

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Python Version](https://img.shields.io/badge/python-3.8+-blue.svg)](https://www.python.org/downloads/)
[![Code style: black](https://img.shields.io/badge/code%20style-black-000000.svg)](https://github.com/psf/black)

Assistant de pr√©paration de datasets d'images pour Fluxgym

## üìã Description

Fluxgym-coach est un outil con√ßu pour faciliter la pr√©paration et l'optimisation des ensembles de donn√©es d'images pour Fluxgym. Il automatise les t√¢ches courantes telles que le renommage des fichiers, l'extraction des m√©tadonn√©es et la gestion des doublons bas√©e sur le contenu.

## ‚ú® Fonctionnalit√©s cl√©s

- **Am√©lioration d'images** : Utilisation de Stable Diffusion Forge pour am√©liorer la qualit√© et la r√©solution
  - **Traitement par lots** : Traitement efficace de plusieurs images en une seule op√©ration
  - **Syst√®me de cache intelligent** : √âvite le retraitement inutile des images inchang√©es
    - V√©rification des empreintes de fichiers (hash MD5)
    - Prise en compte des param√®tres de traitement
    - D√©sactivable via ligne de commande (`--no-cache`)
    - For√ßage du retraitement (`--force-reprocess`)
    - Nettoyage du cache (`--clean-cache`)
    - Personnalisation du r√©pertoire de cache (`--cache-dir`)
  - **Upscaling intelligent** : Augmentation de la r√©solution jusqu'√† 4x
  - **Colorisation automatique** : D√©tection et colorisation automatique des images en noir et blanc
  - **D√©tection automatique N&B** : Identification des images en noir et blanc pour un traitement adapt√©
  - **Conversion de format** : Support de tous les formats courants (PNG, JPG, WebP, etc.)
  - **Redimensionnement proportionnel** : Conservation des proportions avec largeur minimale configurable (1024px par d√©faut)
  - **Gestion m√©moire optimis√©e** : Traitement efficace des lots d'images avec nettoyage automatique des ressources

- **Tests unitaires complets**
  - Couverture de test pour le module d'am√©lioration d'images
  - Tests d'int√©gration avec l'API Stable Diffusion Forge
  - V√©rification des types avec mypy pour une meilleure qualit√© de code
- **D√©duplication intelligente** : D√©tection et gestion des images en double bas√©e sur le hachage de contenu
- **Extraction compl√®te des m√©tadonn√©es** : R√©cup√©ration des donn√©es EXIF et autres m√©tadonn√©es techniques
- **Renommage s√©curis√©** : Utilisation de hachages uniques pour √©viter les conflits de noms
- **Interface en ligne de commande** : Simple et intuitive pour une int√©gration facile dans des pipelines
- **Gestion des erreurs robuste** : Journalisation d√©taill√©e et rapports clairs

## üì¶ Pr√©requis

- Python 3.8 ou sup√©rieur
- pip (gestionnaire de paquets Python)
- Git (pour le clonage du d√©p√¥t)
- Stable Diffusion WebUI Forge (pour l'am√©lioration d'images)

## üß™ Ex√©cution des tests

Pour ex√©cuter les tests unitaires :

```bash
# Installer les d√©pendances de test
pip install -e ".[test]"

# Ex√©cuter tous les tests
pytest

# Ex√©cuter les tests avec couverture
pytest --cov=fluxgym_coach --cov-report=term-missing

# V√©rifier les types avec mypy
mypy .
```

## üõ†Ô∏è D√©veloppement

Le projet utilise plusieurs outils pour assurer la qualit√© du code :

- **mypy** : V√©rification statique des types
- **pytest** : Ex√©cution des tests unitaires
- **black** : Formatage du code
- **flake8** : V√©rification du style de code

Pour configurer l'environnement de d√©veloppement :

```bash
# Installer les d√©pendances de d√©veloppement
pip install -e ".[dev]"

# Formater le code avec black
black .

# V√©rifier le style avec flake8
flake8
```

## üöÄ Installation

### Pr√©requis

- Stable Diffusion WebUI Forge doit √™tre install√© et en cours d'ex√©cution pour l'am√©lioration d'images
- Python 3.8 ou sup√©rieur
- pip (gestionnaire de paquets Python)
- Git (pour le clonage du d√©p√¥t)

### √âtapes d'installation

1. **Cloner le d√©p√¥t** :
   ```bash
   git clone git@gitea.lamachere.fr:fabrice/docker.git
   cd docker/tools/AI/Fluxgym-coach
   ```

2. **Cr√©er et activer un environnement virtuel** (recommand√©) :
   ```bash
   # Sur Linux/Mac
   python -m venv .venv
   source .venv/bin/activate
   
   # Sur Windows
   # python -m venv .venv
   # .venv\Scripts\activate
   ```

3. **Installer les d√©pendances** :
   ```bash
   pip install -e .
   ```
   
4. **Installer les d√©pendances pour le traitement d'images** :
   ```bash
   pip install Pillow numpy requests
   ```

## üõ†Ô∏è Utilisation

### Commandes de base

```bash
# Afficher l'aide
fluxgym-coach --help

# Traiter un dossier d'images (renommage et extraction des m√©tadonn√©es)
fluxgym-coach -i chemin/vers/le/dossier/source -o chemin/vers/le/dossier/destination

# Am√©liorer la qualit√© des images
fluxgym-coach -i source -o destination -p enhance --scale-factor 2
```

### Options de cache

Le syst√®me de cache peut √™tre contr√¥l√© via les options suivantes :

- `--no-cache` : D√©sactive compl√®tement le cache
- `--force-reprocess` : Force le retraitement de toutes les images, m√™me si elles sont en cache
- `--cache-dir CHEMIN` : Sp√©cifie un r√©pertoire personnalis√© pour le cache
- `--clean-cache` : Nettoie les entr√©es obsol√®tes du cache avant le traitement

### Options d'am√©lioration d'images
```bash
python -m fluxgym_coach.image_enhancement chemin/vers/image.jpg --output chemin/de/sortie.jpg
```

#### Traitement par lots

Traiter plusieurs images en une seule commande :

```bash
# Traiter plusieurs images sp√©cifiques
python -m fluxgym_coach.image_enhancement image1.jpg image2.jpg image3.jpg --output dossier/sortie/

# Utiliser un motif glob pour s√©lectionner des fichiers
python -m fluxgym_coach.image_enhancement "dossier/images/*.jpg" --output dossier/sortie/

# Sp√©cifier la taille des lots (par d√©faut: 5)
python -m fluxgym_coach.image_enhancement "dossier/images/*.jpg" --batch-size 10 --output dossier/sortie/

# D√©sactiver le cache (forcer le retraitement)
python -m fluxgym_coach.image_enhancement "dossier/images/*.jpg" --no-cache --output dossier/sortie/

# Forcer le retraitement de toutes les images, m√™me en cache
python -m fluxgym_coach.image_enhancement "dossier/images/*.jpg" --force-reprocess --output dossier/sortie/

# Sp√©cifier un r√©pertoire personnalis√© pour le cache
python -m fluxgym_coach.image_enhancement "dossier/images/*.jpg" --cache-dir /chemin/vers/cache --output dossier/sortie/

# Nettoyer le cache avant le traitement
python -m fluxgym_coach.image_enhancement "dossier/images/*.jpg" --clean-cache --output dossier/sortie/

# Combiner plusieurs options de cache
python -m fluxgym_coach.image_enhancement "dossier/images/*.jpg" --cache-dir /chemin/vers/cache --clean-cache --output dossier/sortie/

# D√©sactiver la colorisation automatique des images N&B
python -m fluxgym_coach.image_enhancement "dossier/images/*.jpg" --no-colorize --output dossier/sortie/
```

#### Options disponibles

- `--output`, `-o` : Chemin de sortie (fichier pour une image, r√©pertoire pour plusieurs images, par d√©faut: <nom_original>_enhanced.<format>)
- `--scale` : Facteur d'√©chelle (1-4, par d√©faut: 2)
- `--api-url` : URL de l'API Stable Diffusion WebUI (par d√©faut: http://127.0.0.1:7860)
- `--batch-size` : Taille des lots pour le traitement par lots (par d√©faut: 5)
- `--no-colorize` : D√©sactive la colorisation automatique des images noir et blanc
- `--upscaler` : Mod√®le d'upscaling √† utiliser (par d√©faut: "R-ESRGAN 4x+ Anime6B")
- `--prompt` : Prompt positif pour guider l'am√©lioration
- `--negative-prompt` : √âl√©ments √† √©viter dans l'image am√©lior√©e

### Exemples avanc√©s

```bash
# Traiter toutes les images JPG et PNG d'un r√©pertoire
python -m fluxgym_coach.image_enhancement "dossier/*.jpg" "dossier/*.png" --output resultats/

# Utiliser un facteur d'√©chelle personnalis√© et un upscaler sp√©cifique
python -m fluxgym_coach.image_enhancement "images/*.jpg" --scale 3 --upscaler "4x-UltraSharp" --output upscaled/

# Traiter des images avec un prompt personnalis√© pour guider l'am√©lioration
python -m fluxgym_coach.image_enhancement "portraits/*.jpg" --prompt "high quality portrait, detailed face, professional photography" --output portraits_enhanced/
```

### Gestion des erreurs

- Les images qui √©chouent au traitement sont ignor√©es, permettant au traitement de se poursuivre avec les autres images
- Un r√©sum√© est affich√© √† la fin du traitement avec le nombre d'images trait√©es avec succ√®s
- Les erreurs d√©taill√©es sont enregistr√©es dans les logs pour analyse

### Options disponibles

```
--input DIR      Dossier source contenant les images √† traiter (obligatoire)
--output DIR     Dossier de destination pour les r√©sultats (obligatoire)
--process TYPE   Type de traitement : 'all', 'images' ou 'metadata' (d√©faut: 'all')
--verbose        Active le mode verbeux pour plus de d√©tails
--config FILE    Chemin vers un fichier de configuration personnalis√©
```

### Exemples

**Traitement complet (images + m√©tadonn√©es)** :
```bash
python -m fluxgym_coach.cli --input ~/images/ --output datasets/ --process all
```

**Extraction des m√©tadonn√©es uniquement** :
```bash
python -m fluxgym_coach.cli --input ~/images/ --output datasets/ --process metadata
```

**Mode verbeux** :
```bash
python -m fluxgym_coach.cli --input ~/images/ --output datasets/ --verbose
```

## üîß Configuration

Le fichier de configuration par d√©faut est charg√© depuis `~/.config/fluxgym/config.json`. Vous pouvez le personnaliser selon vos besoins ou en sp√©cifiant un autre fichier avec l'option `--config`.

## üìä Structure des dossiers

```
output/
‚îú‚îÄ‚îÄ images/           # Images trait√©es et d√©dupliqu√©es
‚îú‚îÄ‚îÄ metadata/         # Fichiers de m√©tadonn√©es au format JSON
‚îî‚îÄ‚îÄ logs/             # Fichiers de journalisation
```

## ü§ù Contribution

Les contributions sont les bienvenues ! N'h√©sitez pas √† ouvrir une issue ou une pull request.

## üìù Protocole de D√©veloppement

Ce projet suit un protocole de d√©veloppement d√©taill√© qui couvre les standards de code, le workflow de d√©veloppement, les bonnes pratiques et plus encore. Consultez le fichier [PROTOCOLE.md](PROTOCOLE.md) pour plus d'informations.

## üìÑ Licence

Ce projet est sous licence MIT. Voir le fichier [LICENSE](LICENSE) pour plus de d√©tails.

## üß™ Tests

Pour ex√©cuter les tests unitaires :

```bash
pytest tests/
```

Pour ex√©cuter les tests d'int√©gration :

```bash
pytest tests/integration/
```

## üìÇ Structure du projet

```
fluxgym-coach/
‚îú‚îÄ‚îÄ fluxgym_coach/           # Code source du package
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py          # Initialisation du package
‚îÇ   ‚îú‚îÄ‚îÄ cli.py               # Interface en ligne de commande
‚îÇ   ‚îú‚îÄ‚îÄ processor.py         # Traitement des images et d√©duplication
‚îÇ   ‚îú‚îÄ‚îÄ metadata.py          # Extraction et gestion des m√©tadonn√©es
‚îÇ   ‚îî‚îÄ‚îÄ utils/               # Utilitaires
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îú‚îÄ‚îÄ config.py        # Gestion de la configuration
‚îÇ       ‚îî‚îÄ‚îÄ validators.py    # Validation des entr√©es
‚îú‚îÄ‚îÄ tests/                   # Tests unitaires et d'int√©gration
‚îÇ   ‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îî‚îÄ‚îÄ unit/
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ CHANGELOG.md            # Historique des modifications
‚îú‚îÄ‚îÄ pyproject.toml          # Configuration du projet
‚îî‚îÄ‚îÄ README.md               # Ce fichier
```

## üë• Auteurs

- Fabrice Lamach√®re - D√©veloppement initial

## üôè Remerciements

- Toute personne ou ressource ayant contribu√© au projet

---

D√©velopp√© avec ‚ù§Ô∏è pour Fluxgym
